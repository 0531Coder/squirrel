<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Squirrel State Machine : squirrel-foundation provided an easy use, type safe and highly extensible state machine implementation for Java." />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Squirrel State Machine</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/hekailiang/squirrel">View on GitHub</a>

          <h1 id="project_title">Squirrel State Machine</h1>
          <h2 id="project_tagline">squirrel-foundation provided an easy use, type safe and highly extensible state machine implementation for Java.</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/hekailiang/squirrel/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/hekailiang/squirrel/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="squirrel-foundation" class="anchor" href="#squirrel-foundation"><span class="octicon octicon-link"></span></a>squirrel-foundation</h1>

<h2>
<a name="what-is-it" class="anchor" href="#what-is-it"><span class="octicon octicon-link"></span></a>What is it?</h2>

<p>Just like the squirrel, a <strong>small</strong>, <strong>agile</strong>, <strong>smart</strong>, <strong>alert</strong> and <strong>cute</strong> animal, squirrel-foundation is aimed to provide a <strong>lightweright</strong>, highly <strong>flexible</strong> and <strong>extensible</strong>, <strong>diagnosable</strong>, <strong>easy use</strong> and <strong>type safe</strong> Java state machine implementation for enterprise usage.  </p>

<p>Here is the state machine diagram which describes the state change of an ATM:  </p>

<p><img src="http://hekailiang.github.io/squirrel/images/ATMStateMachine.png" alt="ATMStateMachine"><br>
The sample code could be found in package <em>"org.squirrelframework.foundation.fsm.atm"</em>.</p>

<h2>
<a name="maven" class="anchor" href="#maven"><span class="octicon octicon-link"></span></a>Maven</h2>

<p>squirrel-foundation has been deployed to maven central repository, so you only need to add following  dependency to the pom.xml.</p>

<p>Latest Released Version:</p>

<pre lang="maven"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.squirrelframework&lt;/groupId&gt;
    &lt;artifactId&gt;squirrel-foundation&lt;/artifactId&gt;
    &lt;version&gt;0.2.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>Latest Snapshot Version:</p>

<pre lang="maven"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.squirrelframework&lt;/groupId&gt;
    &lt;artifactId&gt;squirrel-foundation&lt;/artifactId&gt;
    &lt;version&gt;0.2.2-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<h2>
<a name="user-guide" class="anchor" href="#user-guide"><span class="octicon octicon-link"></span></a>User Guide</h2>

<h3>
<a name="get-starting" class="anchor" href="#get-starting"><span class="octicon octicon-link"></span></a>Get Starting</h3>

<p><strong>squirrel-foundation</strong> supports both fluent API and declarative manner to declare a state machine, and also enable user to define the action methods in a straightforward manner. </p>

<ul>
<li>
<p><strong>StateMahcine</strong> interface takes four generic type parameters.  </p>

<ul>
<li>
<strong>T</strong> stands for the type of implemented state machine.</li>
<li>
<strong>S</strong> stands for the type of implemented state.</li>
<li>
<strong>E</strong> stands for the type of implemented event.</li>
<li>
<strong>C</strong> stands for the type of implemented external context.</li>
</ul>
</li>
<li>
<p><strong>State Machine Builder</strong>  </p>

<ul>
<li>The StateMachineBuilder is composed of *TransitionBuilder (InternalTransitionBuilder / LocalTransitionBuilder / ExternalTransitionBuilder) which is used to build transition between states, and EntryExitActionBuilder which is used to build the actions during entry or exit state. </li>
<li>The internal state is implicitly built during transition creation or state action creation.<br>
</li>
</ul>
<p>In order to create a state machine, user need to create state machine builder first. For example:   </p>

<div class="highlight highlight-java"><pre><span class="n">StateMachineBuilder</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">,</span> <span class="n">MyState</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">&gt;</span> <span class="n">builder</span> <span class="o">=</span>
    <span class="n">StateMachineBuilderFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">MyStateMachine</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">MyState</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</li>
<li>
<p><strong>Fluent API</strong><br>
After state machine builder was created, we can use fluent API to define state/transition/action of the state machine.</p>

<div class="highlight highlight-java"><pre><span class="n">builder</span><span class="o">.</span><span class="na">externalTransition</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">A</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">B</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">MyEvent</span><span class="o">.</span><span class="na">GoToB</span><span class="o">);</span>
</pre></div>

<p>An <strong>external transition</strong> is built between state 'A' to state 'B' and triggered on received event 'GoToB'.</p>

<div class="highlight highlight-java"><pre><span class="n">builder</span><span class="o">.</span><span class="na">internalTransition</span><span class="o">().</span><span class="na">within</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">A</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">MyEvent</span><span class="o">.</span><span class="na">WithinA</span><span class="o">).</span><span class="na">perform</span><span class="o">(</span><span class="n">myAction</span><span class="o">);</span>
</pre></div>

<p>An <strong>internal transition</strong> is build inside state 'A' on event 'WithinA' perform 'myAction'. The internal transition means after transition complete, no state is exited or entered.</p>

<div class="highlight highlight-java"><pre><span class="n">builder</span><span class="o">.</span><span class="na">externalTransition</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">C</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">D</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">MyEvent</span><span class="o">.</span><span class="na">GoToD</span><span class="o">).</span><span class="na">when</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">Condition</span><span class="o">&lt;</span><span class="n">MyContext</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSatisfied</span><span class="o">(</span><span class="n">MyContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">context</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="o">.</span><span class="na">getValue</span><span class="o">()&gt;</span><span class="mi">80</span><span class="o">;</span>
        <span class="o">}</span>
<span class="o">});</span>
</pre></div>

<p>An <strong>conditional transition</strong> is built from state 'C' to state 'D' on event 'GoToD' when external context satisfied the condition restriction.</p>

<div class="highlight highlight-java"><pre><span class="n">builder</span><span class="o">.</span><span class="na">onEntry</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">A</span><span class="o">).</span><span class="na">perform</span><span class="o">(</span><span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">(</span><span class="n">action1</span><span class="o">,</span> <span class="n">action2</span><span class="o">))</span>
</pre></div>

<p>A list of state entry actions is defined.</p>
</li>
<li>
<p><strong>Method Call Action</strong><br>
User can define actions during define transitions or state entry actions. However, the actions will be scattered over the definitions method blocks and other classes. Moreover, other user cannot override the actions. Thus, squirrel-foundation also support define method call actions within state machine implementation in a <strong>Convention Over Configuration</strong> manner.<br>
Basically, this means that if the method declared in state machine satisfied naming and parameters convention, it will be added into the transition action list and also be invoked at certain phase. e.g.  </p>

<div class="highlight highlight-java"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">transitFromAToBOnGoToB</span><span class="o">(</span><span class="n">MyState</span> <span class="n">from</span><span class="o">,</span> <span class="n">MyState</span> <span class="n">to</span><span class="o">,</span> <span class="n">MyEvent</span> <span class="n">event</span><span class="o">,</span> <span class="n">MyContext</span> <span class="n">context</span><span class="o">)</span>
</pre></div>

<p>The method named as <strong>transitFrom[SourceStateName]To[TargetStateName]On[EventName]</strong>, and parameterized as [MyState, MyState, MyEvent, MyContext] will be added into transition "A-(GoToB)-&gt;B" action list. When transiting from state 'A' to state 'B' on event 'GoToB', this method will be invoked.</p>

<div class="highlight highlight-java"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">transitFromAnyToBOnGoToB</span><span class="o">(</span><span class="n">MyState</span> <span class="n">from</span><span class="o">,</span> <span class="n">MyState</span> <span class="n">to</span><span class="o">,</span> <span class="n">MyEvent</span> <span class="n">event</span><span class="o">,</span> <span class="n">MyContext</span> <span class="n">context</span><span class="o">)</span>
</pre></div>

<p><strong>transitFromAnyTo[TargetStateName]On[EventName]</strong> The method will be invoked when transit from any state to state 'B' on event 'GoToB'.</p>

<div class="highlight highlight-java"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">exitA</span><span class="o">(</span><span class="n">MyState</span> <span class="n">from</span><span class="o">,</span> <span class="n">MyState</span> <span class="n">to</span><span class="o">,</span> <span class="n">MyEvent</span> <span class="n">event</span><span class="o">,</span> <span class="n">MyContext</span> <span class="n">context</span><span class="o">)</span>
</pre></div>

<p><strong>exit[StateName]</strong> The method will be invoked when exit state 'A'. So as the <strong>entry[StateName]</strong> , <strong>exitAny</strong> and <strong>entryAny</strong>.  </p>

<p><strong><em>Other Supported Naming Patterns:</em></strong></p>

<pre><code>transitFrom[fromStateName]To[toStateName]On[eventName]When[conditionName]  
transitFrom[fromStateName]To[toStateName]On[eventName]  
transitFromAnyTo[toStateName]On[eventName]  
transitFrom[fromStateName]ToAnyOn[eventName]  
transitFrom[fromStateName]To[toStateName]          
on[eventName] 
</code></pre>
</li>
<li>
<p><strong>Declarative Annotation</strong><br>
Use conventional way to define action method call is convenient, but sometimes user may want to give method a more meaningful name. Moreover, the java compiler cannot help user to detect the error when misspelling the method name. For this case, a declarative way is also provided to define and also to extend the state machine. Here is an example.  </p>

<div class="highlight highlight-java"><pre><span class="nd">@States</span><span class="o">({</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"A"</span><span class="o">,</span> <span class="n">entryCallMethod</span><span class="o">=</span><span class="s">"entryStateA"</span><span class="o">,</span> <span class="n">exitCallMethod</span><span class="o">=</span><span class="s">"exitStateA"</span><span class="o">),</span> 
    <span class="nd">@State</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"B"</span><span class="o">,</span> <span class="n">entryCallMethod</span><span class="o">=</span><span class="s">"entryStateB"</span><span class="o">,</span> <span class="n">exitCallMethod</span><span class="o">=</span><span class="s">"exitStateB"</span><span class="o">)</span>
<span class="o">})</span>
<span class="nd">@Transitions</span><span class="o">({</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"A"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"B"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"GoToB"</span><span class="o">,</span> <span class="n">callMethod</span><span class="o">=</span><span class="s">"stateAToStateBOnGotoB"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"A"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"A"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"WithinA"</span><span class="o">,</span> <span class="n">callMethod</span><span class="o">=</span><span class="s">"stateAToStateAOnWithinA"</span><span class="o">,</span> <span class="n">type</span><span class="o">=</span><span class="n">TransitionType</span><span class="o">.</span><span class="na">INTERNAL</span><span class="o">)</span>
<span class="o">})</span>
<span class="kd">interface</span> <span class="nc">MyStateMachine</span> <span class="kd">extends</span> <span class="n">StateMachine</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">,</span> <span class="n">MyState</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">entryStateA</span><span class="o">(</span><span class="n">MyState</span> <span class="n">from</span><span class="o">,</span> <span class="n">MyState</span> <span class="n">to</span><span class="o">,</span> <span class="n">MyEvent</span> <span class="n">event</span><span class="o">,</span> <span class="n">MyContext</span> <span class="n">context</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">stateAToStateBOnGotoB</span><span class="o">(</span><span class="n">MyState</span> <span class="n">from</span><span class="o">,</span> <span class="n">MyState</span> <span class="n">to</span><span class="o">,</span> <span class="n">MyEvent</span> <span class="n">event</span><span class="o">,</span> <span class="n">MyContext</span> <span class="n">context</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">stateAToStateAOnWithinA</span><span class="o">(</span><span class="n">MyState</span> <span class="n">from</span><span class="o">,</span> <span class="n">MyState</span> <span class="n">to</span><span class="o">,</span> <span class="n">MyEvent</span> <span class="n">event</span><span class="o">,</span> <span class="n">MyContext</span> <span class="n">context</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">exitStateA</span><span class="o">(</span><span class="n">MyState</span> <span class="n">from</span><span class="o">,</span> <span class="n">MyState</span> <span class="n">to</span><span class="o">,</span> <span class="n">MyEvent</span> <span class="n">event</span><span class="o">,</span> <span class="n">MyContext</span> <span class="n">context</span><span class="o">);</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>

<p>The annotation can be defined in both implementation class of state machine or any interface that state machine will be implemented. It also can be used mixed with fluent API, which means the state machine defined in fluent API can also be extended by these annotations. (One thing you may need to be noticed, the method defined within interface must be public, which means also the method call action implementation will be public to caller.)  </p>
</li>
<li>
<p><strong>Converters</strong><br>
In order to declare state and event within <em><a href="https://github.com/State" class="user-mention">@State</a></em> and <em><a href="https://github.com/Transit" class="user-mention">@Transit</a></em>, user need to implement corresponding converters for their state(S) and event(E) type. The convert must implement Converter&lt;T&gt; interface, which convert the state/event to/from String.</p>

<div class="highlight highlight-java"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Converter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">SquirrelComponent</span> <span class="o">{</span>
    <span class="cm">/**</span>
<span class="cm">    * Convert object to string.</span>
<span class="cm">    * @param obj converted object</span>
<span class="cm">    * @return string description of object</span>
<span class="cm">    */</span>
    <span class="n">String</span> <span class="nf">convertToString</span><span class="o">(</span><span class="n">T</span> <span class="n">obj</span><span class="o">);</span>

    <span class="cm">/**</span>
<span class="cm">    * Convert string to object.</span>
<span class="cm">    * @param name name of the object</span>
<span class="cm">    * @return converted object</span>
<span class="cm">    */</span>
    <span class="n">T</span> <span class="nf">convertFromString</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>

<p>Then register these converters to <em>ConverterProvider</em>. e.g.</p>

<div class="highlight highlight-java"><pre><span class="n">ConverterProvider</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">MyEvent</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">MyEventConverter</span><span class="o">());</span>
<span class="n">ConverterProvider</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">MyStateConverter</span><span class="o">());</span>
</pre></div>

<p><em>Note: If you only use fluent API to define state machine, there is no need to implement corresponding converters. And also if the Event or State class is type of String or Enumeration, you don't need to implement or register a converter explictly at most of cases.</em></p>
</li>
<li>
<p><strong>New State Machine Instance</strong><br>
After user defined state machine behavior, user could create a new state machine instance through builder. Note, once the state machine instance is created from the builder, the builder cannot used to define any new element of state machine anymore.</p>

<div class="highlight highlight-java"><pre><span class="n">T</span> <span class="nf">newStateMachine</span><span class="o">(</span><span class="n">S</span> <span class="n">initialStateId</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">extraParams</span><span class="o">);</span>
</pre></div>

<p>To create a new state machine instance from state machine builder, you need to pass following parameters.</p>

<ol>
<li>
<em>initialStateId</em>: When started, the initial state of the state machine.</li>
<li>
<em>extraParams</em>: Extra parameters that needed for create new state machine instance. Set to <em>"new Object[0]"</em> for no extra parameters needed.<br>
</li>
</ol>
<p>New state machine from state machine builder.</p>

<div class="highlight highlight-java"><pre><span class="n">MyStateMachine</span> <span class="n">stateMachine</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">newStateMachine</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">Initial</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
</pre></div>
</li>
<li>
<p><strong>Fire Events</strong><br>
After state machine was created, user can fire events along with context to trigger transition inside state machine. e.g.</p>

<div class="highlight highlight-java"><pre><span class="n">stateMachine</span><span class="o">.</span><span class="na">fire</span><span class="o">(</span><span class="n">MyEvent</span><span class="o">.</span><span class="na">Prepare</span><span class="o">,</span> <span class="k">new</span> <span class="n">MyContext</span><span class="o">(</span><span class="s">"Testing"</span><span class="o">));</span>
</pre></div>
</li>
</ul><h3>
<a name="advanced-feature" class="anchor" href="#advanced-feature"><span class="octicon octicon-link"></span></a>Advanced Feature</h3>

<ul>
<li>
<p><strong>Define Hierarchical State</strong><br>
A hierarchical state may contain nested state. The child states may themselves have nested children and the nesting may proceed to any depth. When a hierarchical state is active, one and only one of its child states is active. The hierarchical state can be defined through API or annotation.</p>

<div class="highlight highlight-java"><pre><span class="kt">void</span> <span class="nf">defineSequentialStatesOn</span><span class="o">(</span><span class="n">S</span> <span class="n">parentStateId</span><span class="o">,</span> <span class="n">S</span><span class="o">...</span> <span class="n">childStateIds</span><span class="o">);</span>
</pre></div>

<p><em>builder.defineHierarchyOn(State.A, State.BinA, StateCinA)</em> defines two child states "BinA" and "CinA" under parent state "A", the first defined child state will also be the initial state of the hierarchical state "A". The same hierarchical state can also be defined through annotation, e.g.</p>

<div class="highlight highlight-java"><pre><span class="nd">@States</span><span class="o">({</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"A"</span><span class="o">,</span> <span class="n">entryMethodCall</span><span class="o">=</span><span class="s">"entryA"</span><span class="o">,</span> <span class="n">exitMethodCall</span><span class="o">=</span><span class="s">"exitA"</span><span class="o">),</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">parent</span><span class="o">=</span><span class="s">"A"</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"BinA"</span><span class="o">,</span> <span class="n">entryMethodCall</span><span class="o">=</span><span class="s">"entryBinA"</span><span class="o">,</span> <span class="n">exitMethodCall</span><span class="o">=</span><span class="s">"exitBinA"</span><span class="o">,</span> <span class="n">initialState</span><span class="o">=</span><span class="kc">true</span><span class="o">),</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">parent</span><span class="o">=</span><span class="s">"A"</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"CinA"</span><span class="o">,</span> <span class="n">entryMethodCall</span><span class="o">=</span><span class="s">"entryCinA"</span><span class="o">,</span> <span class="n">exitMethodCall</span><span class="o">=</span><span class="s">"exitCinA"</span><span class="o">)</span>
<span class="o">})</span>
</pre></div>
</li>
<li>
<p><strong>Define Parallel State</strong><br>
The parallel state encapsulates a set of child states which are simultaneously active when the parent element is active. The  parallel state can be defined through API or annotation both. e.g.<br><img src="http://hekailiang.github.io/squirrel/images/ParallelStates.png" alt="ParallelStates"></p>

<div class="highlight highlight-java"><pre><span class="c1">// defines two region states "RegionState1" and "RegionState2" under parent parallel state "Root"</span>
<span class="n">builder</span><span class="o">.</span><span class="na">defineParallelStatesOn</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">Root</span><span class="o">,</span> <span class="n">MyState</span><span class="o">.</span><span class="na">RegionState1</span><span class="o">,</span> <span class="n">MyState</span><span class="o">.</span><span class="na">RegionState2</span><span class="o">);</span>

<span class="n">builder</span><span class="o">.</span><span class="na">defineSequentialStatesOn</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">RegionState1</span><span class="o">,</span> <span class="n">MyState</span><span class="o">.</span><span class="na">State11</span><span class="o">,</span> <span class="n">MyState</span><span class="o">.</span><span class="na">State12</span><span class="o">);</span>
<span class="n">builder</span><span class="o">.</span><span class="na">externalTransition</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">State11</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">State12</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">MyEvent</span><span class="o">.</span><span class="na">Event1</span><span class="o">);</span>

<span class="n">builder</span><span class="o">.</span><span class="na">defineSequentialStatesOn</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">RegionState2</span><span class="o">,</span> <span class="n">MyState</span><span class="o">.</span><span class="na">State21</span><span class="o">,</span> <span class="n">MyState</span><span class="o">.</span><span class="na">State22</span><span class="o">);</span>
<span class="n">builder</span><span class="o">.</span><span class="na">externalTransition</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">State21</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">State22</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">MyEvent</span><span class="o">.</span><span class="na">Event2</span><span class="o">);</span>
</pre></div>

<p>or  </p>

<div class="highlight highlight-java"><pre><span class="nd">@States</span><span class="o">({</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Root"</span><span class="o">,</span> <span class="n">entryCallMethod</span><span class="o">=</span><span class="s">"enterRoot"</span><span class="o">,</span> <span class="n">exitCallMethod</span><span class="o">=</span><span class="s">"exitRoot"</span><span class="o">,</span> <span class="n">compositeType</span><span class="o">=</span><span class="n">StateCompositeType</span><span class="o">.</span><span class="na">PARALLEL</span><span class="o">),</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">parent</span><span class="o">=</span><span class="s">"Root"</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"RegionState1"</span><span class="o">,</span> <span class="n">entryCallMethod</span><span class="o">=</span><span class="s">"enterRegionState1"</span><span class="o">,</span> <span class="n">exitCallMethod</span><span class="o">=</span><span class="s">"exitRegionState1"</span><span class="o">),</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">parent</span><span class="o">=</span><span class="s">"Root"</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"RegionState2"</span><span class="o">,</span> <span class="n">entryCallMethod</span><span class="o">=</span><span class="s">"enterRegionState2"</span><span class="o">,</span> <span class="n">exitCallMethod</span><span class="o">=</span><span class="s">"exitRegionState2"</span><span class="o">)</span>
<span class="o">})</span>
</pre></div>

<p>To get current sub states of the parallel state</p>

<div class="highlight highlight-java"><pre><span class="n">stateMachine</span><span class="o">.</span><span class="na">getSubStatesOn</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">Root</span><span class="o">);</span> <span class="c1">// return list of current sub states of parallel state</span>
</pre></div>
</li>
<li>
<p><strong>Using History States to Save and Restore the Current State</strong><br>
The history pseudo-state allows a state machine to remember its state configuration. A transition taking the history state as its target will return the state machine to this recorded configuration. If the 'type' of a history is "shallow", the state machine processor must record the direct  active children of its parent before taking any transition that exits the parent. If the 'type' of a history is "deep", the state machine processor must record all the active  descendants of the parent before taking any transition that exits the parent.<br>
Both API and annotation are supported to define history type of state. e.g.  </p>

<div class="highlight highlight-java"><pre><span class="c1">// defined history type of state "A" as "deep"</span>
<span class="n">builder</span><span class="o">.</span><span class="na">defineSequentialStatesOn</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">A</span><span class="o">,</span> <span class="n">HistoryType</span><span class="o">.</span><span class="na">DEEP</span><span class="o">,</span> <span class="n">MyState</span><span class="o">.</span><span class="na">A1</span><span class="o">,</span> <span class="n">MyState</span><span class="o">.</span><span class="na">A2</span><span class="o">)</span>
</pre></div>

<p>or</p>

<div class="highlight highlight-java"><pre><span class="nd">@State</span><span class="o">(</span><span class="n">parent</span><span class="o">=</span><span class="s">"A"</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"A1"</span><span class="o">,</span> <span class="n">entryCallMethod</span><span class="o">=</span><span class="s">"enterA1"</span><span class="o">,</span>    <span class="n">exitCallMethod</span><span class="o">=</span><span class="s">"exitA1"</span><span class="o">,</span> <span class="n">historyType</span><span class="o">=</span><span class="n">HistoryType</span><span class="o">.</span><span class="na">DEEP</span><span class="o">)</span>
</pre></div>
</li>
<li>
<p><strong>Transition Types</strong><br>
According to the UML specification, a transition may be one of these three kinds:    </p>

<blockquote>
<ul>
<li>
<em>Internal Transition</em><br>
Implies that the Transition, if triggered, occurs without exiting or entering the source State (i.e., it does not cause a state change). This means that the entry or exit condition of the source State will not be invoked. An internal Transition can be taken even if the StateMachine is in one or more Regions nested within the associated State.<br>
</li>
<li>
<em>Local Transition</em><br>
Implies that the Transition, if triggered, will not exit the composite (source) State, but it will exit and re-enter any state within the composite State that is in the current state configuration.</li>
<li>
<em>External Transition</em><br>
Implies that the Transition, if triggered, will exit the composite (source) State<br>
</li>
</ul>
</blockquote>

<p>squirrel-foundation supports both API and annotation to declare all kinds of transitions, e.g.  </p>

<div class="highlight highlight-java"><pre><span class="n">builder</span><span class="o">.</span><span class="na">externalTransition</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">A</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">B</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">MyEvent</span><span class="o">.</span><span class="na">A2B</span><span class="o">);</span>
<span class="n">builder</span><span class="o">.</span><span class="na">internalTransition</span><span class="o">().</span><span class="na">within</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">A</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">MyEvent</span><span class="o">.</span><span class="na">innerA</span><span class="o">);</span>
<span class="n">builder</span><span class="o">.</span><span class="na">localTransition</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">A</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">MyState</span><span class="o">.</span><span class="na">CinA</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">MyEvent</span><span class="o">.</span><span class="na">intoC</span><span class="o">)</span>
</pre></div>

<p>or  </p>

<div class="highlight highlight-java"><pre><span class="nd">@Transitions</span><span class="o">({</span>
    <span class="nd">@Transition</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"A"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"B"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"A2B"</span><span class="o">),</span> <span class="c1">//default value of transition type is EXTERNAL</span>
    <span class="nd">@Transition</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"A"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"innerA"</span><span class="o">,</span> <span class="n">type</span><span class="o">=</span><span class="n">TransitionType</span><span class="o">.</span><span class="na">INTERNAL</span><span class="o">),</span>
    <span class="nd">@Transition</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"A"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"CinA"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"intoC"</span><span class="o">,</span> <span class="n">type</span><span class="o">=</span><span class="n">TransitionType</span><span class="o">.</span><span class="na">LOCAL</span><span class="o">),</span>
<span class="o">})</span>
</pre></div>
</li>
<li>
<p><strong>State Machine Lifecycle Events</strong><br>
During the lifecycle of the state machine, various events will be fired, e.g. </p>

<pre><code>|--StateMachineEvent                        /* Base event of all state machine event */   
   |--StartEvent                            /* Fired when state machine started      */ 
   |--TerminateEvent                        /* Fired when state machine terminated   */ 
      |--TransitionEvent                    /* Base event of all transition event    */ 
         |--TransitionBeginEvent            /* Fired when transition began           */ 
         |--TransitionCompleteEvent         /* Fired when transition completed       */ 
         |--TransitionExceptionEvent        /* Fired when transition threw exception */ 
         |--TransitionDeclinedListener      /* Fired when transition declined        */ 
</code></pre>

<p>User can add a listener to listen StateMachineEvent, which means all events fired during state machine lifecycle will be caught by this listener, e.g.,</p>

<div class="highlight highlight-java"><pre><span class="n">stateMachine</span><span class="o">.</span><span class="na">addStateMachineListener</span><span class="o">(</span><span class="k">new</span> <span class="n">StateMachineListener</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">,</span> <span class="n">MyState</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stateMachineEvent</span><span class="o">(</span><span class="n">StateMachineEvent</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">,</span> <span class="n">MyState</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">&gt;</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ...</span>
        <span class="o">}</span>
<span class="o">});</span>
</pre></div>
</li>
<li>
<p><strong>State Machine PostProcessor</strong><br>
User can register post processor for specific type of state machine in order to adding post process logic after state machine instantiated, e.g.  </p>

<div class="highlight highlight-java"><pre><span class="c1">// 1 User defined a state machine interface</span>
<span class="kd">interface</span> <span class="nc">MyStateMachine</span> <span class="kd">extends</span> <span class="n">StateMachine</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">,</span> <span class="n">MyState</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
<span class="o">}</span>

<span class="c1">// 2 Both MyStateMachineImpl and MyStateMachineImplEx are implemented MyStateMachine</span>
<span class="kd">class</span> <span class="nc">MyStateMachineImpl</span> <span class="kd">implements</span> <span class="n">MyStateMachine</span> <span class="o">{</span>
    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> 
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">MyStateMachineImplEx</span> <span class="kd">implements</span> <span class="n">MyStateMachine</span> <span class="o">{</span>
    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
<span class="o">}</span>

<span class="c1">// 3 User define a state machine post processor</span>
<span class="n">MyStateMachinePostProcessor</span> <span class="kd">implements</span> <span class="n">SquirrelPostProcessor</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">postProcess</span><span class="o">(</span><span class="n">MyStateMachine</span> <span class="n">component</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> 
    <span class="o">}</span>
<span class="o">}</span>  

<span class="c1">// 4 User register state machine post process</span>
<span class="n">SquirrelPostProcessorProvider</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">MyStateMachine</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">MyStateMachinePostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>

<p>For this case, when user created both MyStateMachineImpl and MyStateMachineImplEx instance, the registered post processor MyStateMachinePostProcessor will be called to do some work.</p>
</li>
<li>
<p><strong>State Machine Intercepter</strong><br>
User can register intercepter for specific type of state machine to insert custom logic during state machine lifecycle. </p>

<div class="highlight highlight-java"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractStateMachineIntercepter</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">StateMachine</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">S</span><span class="o">,</span> <span class="n">E</span><span class="o">,</span> <span class="n">C</span><span class="o">&gt;,</span> <span class="n">S</span><span class="o">,</span> <span class="n">E</span><span class="o">,</span> <span class="n">C</span><span class="o">&gt;</span> 
    <span class="kd">implements</span> <span class="n">StateMachineIntercepter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">S</span><span class="o">,</span> <span class="n">E</span><span class="o">,</span> <span class="n">C</span><span class="o">&gt;,</span> <span class="n">SquirrelPostProcessor</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
<span class="o">}</span>
</pre></div>

<p>User can insert custom logic at different state machine process phases by creating a state machine intercepter which is extended from <em>AbstractStateMachineIntercepter</em>. Actually, the <em>AbstractStateMachineIntercepter</em> also implemented <em>SquirrelPostProcessor</em> interface. It will add a StateMachineEvent listener into the state machine, and dispatch the method call according to the event type. Thus, the StateMachineIntercepter registration should be the same as state machine post processor.<br>
By leveraging state machine intercepter, user can implement various monitors for performance analysis, exception diagnose and so on.  </p>
</li>
<li>
<p><strong>State Machine Export</strong><br>
SCXMLVisitor can be used to export state machine definition in <a href="http://www.w3.org/TR/scxml/">SCXML</a> document.</p>

<div class="highlight highlight-java"><pre><span class="n">SCXMLVisitor</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">,</span> <span class="n">MyState</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">&gt;</span> <span class="n">visitor</span> <span class="o">=</span> <span class="n">SquirrelProvider</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">newInstance</span><span class="o">(</span>
            <span class="k">new</span> <span class="n">TypeReference</span><span class="o">&lt;</span><span class="n">SCXMLVisitor</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">,</span> <span class="n">MyState</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">&gt;&gt;()</span> <span class="o">{});</span>
<span class="n">stateMachine</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">visitor</span><span class="o">);</span>
<span class="n">visitor</span><span class="o">.</span><span class="na">convertSCXMLFile</span><span class="o">(</span><span class="s">"MyStateMachine"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</pre></div>

<p>DotVisitor can be used to generate state diagram which can be viewed by <a href="http://www.graphviz.org/">GraphViz</a>.</p>

<div class="highlight highlight-java"><pre><span class="n">DotVisitor</span><span class="o">&lt;</span><span class="n">SnakeController</span><span class="o">,</span> <span class="n">SnakeState</span><span class="o">,</span> <span class="n">SnakeEvent</span><span class="o">,</span> <span class="n">SnakeContext</span><span class="o">&gt;</span> <span class="n">visitor</span> <span class="o">=</span> <span class="n">SquirrelProvider</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">newInstance</span><span class="o">(</span>
            <span class="k">new</span> <span class="n">TypeReference</span><span class="o">&lt;</span><span class="n">DotVisitor</span><span class="o">&lt;</span><span class="n">SnakeController</span><span class="o">,</span> <span class="n">SnakeState</span><span class="o">,</span> <span class="n">SnakeEvent</span><span class="o">,</span> <span class="n">SnakeContext</span><span class="o">&gt;&gt;()</span> <span class="o">{});</span>
<span class="n">stateMachine</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">visitor</span><span class="o">);</span>
<span class="n">visitor</span><span class="o">.</span><span class="na">convertDotFile</span><span class="o">(</span><span class="s">"SnakeStateMachine"</span><span class="o">);</span>
</pre></div>
</li>
<li>
<p><strong>Save/Load State Machine Data</strong><br>
User can save data of state machine when state machine is in idle status.</p>

<div class="highlight highlight-java"><pre><span class="n">StateMachineData</span><span class="o">.</span><span class="na">Reader</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">,</span> <span class="n">MyState</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">&gt;</span> 
    <span class="n">savedData</span> <span class="o">=</span> <span class="n">stateMachine</span><span class="o">.</span><span class="na">dumpSavedData</span><span class="o">();</span>
</pre></div>

<p>And also user can load above <em>savedData</em> into another state machine whose status is terminated or just initialized.</p>

<div class="highlight highlight-java"><pre><span class="n">newStateMachineInstance</span><span class="o">.</span><span class="na">loadSavedData</span><span class="o">(</span><span class="n">savedData</span><span class="o">);</span>
</pre></div>
</li>
<li>
<p><strong>State Machine Diagnose</strong><br>
User can register various monitors as state machine intercepter to observe internal status of the state machine, like the execution performance, action calling sequence, transition progress and so on.<br>
For example, the following code is used to register an execution time monitor for state machine of <em>MyStateMachine</em> type.</p>

<div class="highlight highlight-java"><pre><span class="n">SquirrelPostProcessorProvider</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">MyStateMachine</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> 
            <span class="k">new</span> <span class="n">TypeReference</span><span class="o">&lt;</span><span class="n">TransitionExecTimeMonitor</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">,</span> <span class="n">MyState</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">&gt;&gt;()</span> <span class="o">{});</span>
</pre></div>

<p>The following code is used to monitor transition progress by adding a <em>TransitionProgressMonitor</em> to <em>ActionExecutor</em> to monitor transition action execution.</p>

<div class="highlight highlight-java"><pre><span class="n">SquirrelPostProcessorProvider</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">register</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">TypeReference</span><span class="o">&lt;</span><span class="n">ActionExecutor</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">,</span> <span class="n">MyState</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">&gt;&gt;(){},</span> 
    <span class="k">new</span> <span class="n">SquirrelPostProcessor</span><span class="o">&lt;</span><span class="n">ActionExecutor</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">,</span> <span class="n">MyState</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcess</span><span class="o">(</span><span class="n">ActionExecutor</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">,</span> <span class="n">MyState</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">&gt;</span> <span class="n">component</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">component</span><span class="o">.</span><span class="na">addExecActionListener</span><span class="o">(</span><span class="k">new</span> <span class="n">TransitionProgressMonitor</span><span class="o">&lt;</span><span class="n">MyStateMachine</span><span class="o">,</span> <span class="n">MyState</span><span class="o">,</span> <span class="n">MyEvent</span><span class="o">,</span> <span class="n">MyContext</span><span class="o">&gt;());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">);</span>
</pre></div>

<p>Add <strong>@LogExecTime</strong> on action method will log out the execution time of the method. And also add the @LogExecTime on state machine class will log out all the action method execution time. For example, the execution time of method <em>transitFromAToBOnGoToB</em> will be logged out.</p>

<div class="highlight highlight-java"><pre><span class="nd">@LogExecTime</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">transitFromAToBOnGoToB</span><span class="o">(</span><span class="n">MyState</span> <span class="n">from</span><span class="o">,</span> <span class="n">MyState</span> <span class="n">to</span><span class="o">,</span> <span class="n">MyEvent</span> <span class="n">event</span><span class="o">,</span> <span class="n">MyContext</span> <span class="n">context</span><span class="o">)</span>
</pre></div>
</li>
<li>
<p><strong>Linked State (so called Submachine State)</strong><br>
A <strong>linked state</strong> specifies the insertion of the specification of a submachine state machine. The state machine that contains the linked state is called the containing state machine. The same state machine may be a submachine more than once in the context of a single containing state machine.  </p>

<p>A linked state is semantically equivalent to a composite state. The regions of the submachine state machine are the regions of the composite state. The entry, exit, and behavior actions and internal transitions are defined as part of the state. Submachine state is a decomposition mechanism that allows factoring of common behaviors and their reuse.<br>
The linked state can be defined by following sample code.</p>

<div class="highlight highlight-java"><pre><span class="n">builderOfTestStateMachine</span><span class="o">.</span><span class="na">definedLinkedState</span><span class="o">(</span><span class="n">LState</span><span class="o">.</span><span class="na">A</span><span class="o">,</span> <span class="n">builderOfLinkedStateMachine</span><span class="o">,</span> <span class="n">LState</span><span class="o">.</span><span class="na">A1</span><span class="o">);</span>
</pre></div>
</li>
</ul><h3>
<a name="examples" class="anchor" href="#examples"><span class="octicon octicon-link"></span></a>Examples</h3>

<ul>
<li><p><strong>ATM State Machine</strong><br>
The sample code could be found in package <em>"org.squirrelframework.foundation.fsm.atm"</em>.  </p></li>
<li>
<p><strong>Simple CSS Parser</strong><br>
This example illustrates how to parse incoming characters by define parser grammar in state machine.<br><img src="http://hekailiang.github.io/squirrel/images/SimpleCssParser.png" alt="SimpleCssParser"><br>
Parse CSS scripts with <em>SimpleCssParser</em> which is defined as State Machine.</p>

<div class="highlight highlight-java"><pre><span class="n">SimpleCssParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">SimpleCssParser</span><span class="o">.</span><span class="na">newParser</span><span class="o">();</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">CssRule</span><span class="o">&gt;</span> <span class="n">rules</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"alpha { width: 100px/*comment1*/; /*comment2*/text-decoration: "</span> <span class="o">+</span> 
    <span class="s">"/*comment3*/ underlined; } epsilon/*comment4*/, zeta{ height: 34px; } "</span><span class="o">);</span>
</pre></div>

<p>Sample code to define CssParser could be found in package <em>"org.squirrelframework.foundation.fsm.cssparser"</em>.</p>
</li>
<li>
<p><strong>Greedy Snake Game Sample</strong><br>
Here is an interesting example which used state machine to implement greedy snake game  controller. The following diagram shows that the state machine definition of the controller.<br><img src="http://hekailiang.github.io/squirrel/images/SnakeGame.png" alt="SnakeStateMachine"><br>
Sample code to create snake game state machine.</p>

<div class="highlight highlight-java"><pre><span class="nd">@States</span><span class="o">({</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"NEW"</span><span class="o">),</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"MOVE"</span><span class="o">,</span> <span class="n">historyType</span><span class="o">=</span><span class="n">HistoryType</span><span class="o">.</span><span class="na">DEEP</span><span class="o">),</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">parent</span><span class="o">=</span><span class="s">"MOVE"</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"UP"</span><span class="o">,</span> <span class="n">initialState</span><span class="o">=</span><span class="kc">true</span><span class="o">),</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">parent</span><span class="o">=</span><span class="s">"MOVE"</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"LEFT"</span><span class="o">),</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">parent</span><span class="o">=</span><span class="s">"MOVE"</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"RIGHT"</span><span class="o">),</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">parent</span><span class="o">=</span><span class="s">"MOVE"</span><span class="o">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"DOWN"</span><span class="o">),</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PAUSE"</span><span class="o">),</span>
    <span class="nd">@State</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"GAMEOVER"</span><span class="o">)</span>
<span class="o">})</span>
<span class="nd">@Transitions</span><span class="o">({</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"NEW"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"MOVE"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"PRESS_START"</span><span class="o">,</span> <span class="n">callMethod</span><span class="o">=</span><span class="s">"onStart"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="s">"GAMEOVER"</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="s">"MOVE"</span><span class="o">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s">"PRESS_START"</span><span class="o">,</span> <span class="n">callMethod</span> <span class="o">=</span> <span class="s">"onStart"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="s">"MOVE"</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="s">"GAMEOVER"</span><span class="o">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s">"MOVE_AHEAD"</span><span class="o">,</span> <span class="n">callMethod</span> <span class="o">=</span> <span class="s">"onEnd"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="s">"MOVE"</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="s">"GAMEOVER"</span><span class="o">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s">"BODY_COLLAPSED"</span><span class="o">,</span> <span class="n">callMethod</span> <span class="o">=</span> <span class="s">"onEnd"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="s">"UP"</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="s">"UP"</span><span class="o">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s">"MOVE_AHEAD"</span><span class="o">,</span> <span class="n">callMethod</span> <span class="o">=</span> <span class="s">"onMove"</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">TransitionType</span><span class="o">.</span><span class="na">INTERNAL</span><span class="o">,</span> <span class="n">when</span> <span class="o">=</span> <span class="n">SnakeController</span><span class="o">.</span><span class="na">InBorderCondition</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="s">"DOWN"</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="s">"DOWN"</span><span class="o">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s">"MOVE_AHEAD"</span><span class="o">,</span> <span class="n">callMethod</span> <span class="o">=</span> <span class="s">"onMove"</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">TransitionType</span><span class="o">.</span><span class="na">INTERNAL</span><span class="o">,</span> <span class="n">when</span> <span class="o">=</span> <span class="n">SnakeController</span><span class="o">.</span><span class="na">InBorderCondition</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="s">"LEFT"</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="s">"LEFT"</span><span class="o">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s">"MOVE_AHEAD"</span><span class="o">,</span> <span class="n">callMethod</span> <span class="o">=</span> <span class="s">"onMove"</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">TransitionType</span><span class="o">.</span><span class="na">INTERNAL</span><span class="o">,</span> <span class="n">when</span> <span class="o">=</span> <span class="n">SnakeController</span><span class="o">.</span><span class="na">InBorderCondition</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="s">"RIGHT"</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="s">"RIGHT"</span><span class="o">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s">"MOVE_AHEAD"</span><span class="o">,</span> <span class="n">callMethod</span> <span class="o">=</span> <span class="s">"onMove"</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">TransitionType</span><span class="o">.</span><span class="na">INTERNAL</span><span class="o">,</span> <span class="n">when</span> <span class="o">=</span> <span class="n">SnakeController</span><span class="o">.</span><span class="na">InBorderCondition</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"MOVE"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"PAUSE"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"PRESS_PAUSE"</span><span class="o">,</span> <span class="n">callMethod</span><span class="o">=</span><span class="s">"onPause"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"PAUSE"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"MOVE"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"PRESS_PAUSE"</span><span class="o">,</span> <span class="n">callMethod</span><span class="o">=</span><span class="s">"onResume"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"UP"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"LEFT"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"TURN_LEFT"</span><span class="o">,</span> <span class="n">callMethod</span><span class="o">=</span><span class="s">"onChangeDirection"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"UP"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"RIGHT"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"TURN_RIGHT"</span><span class="o">,</span> <span class="n">callMethod</span><span class="o">=</span><span class="s">"onChangeDirection"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"DOWN"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"LEFT"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"TURN_LEFT"</span><span class="o">,</span> <span class="n">callMethod</span><span class="o">=</span><span class="s">"onChangeDirection"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"DOWN"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"RIGHT"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"TURN_RIGHT"</span><span class="o">,</span> <span class="n">callMethod</span><span class="o">=</span><span class="s">"onChangeDirection"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"LEFT"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"UP"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"TURN_UP"</span><span class="o">,</span> <span class="n">callMethod</span><span class="o">=</span><span class="s">"onChangeDirection"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"LEFT"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"DOWN"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"TURN_DOWN"</span><span class="o">,</span> <span class="n">callMethod</span><span class="o">=</span><span class="s">"onChangeDirection"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"RIGHT"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"UP"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"TURN_UP"</span><span class="o">,</span> <span class="n">callMethod</span><span class="o">=</span><span class="s">"onChangeDirection"</span><span class="o">),</span>
    <span class="nd">@Transit</span><span class="o">(</span><span class="n">from</span><span class="o">=</span><span class="s">"RIGHT"</span><span class="o">,</span> <span class="n">to</span><span class="o">=</span><span class="s">"DOWN"</span><span class="o">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"TURN_DOWN"</span><span class="o">,</span> <span class="n">callMethod</span><span class="o">=</span><span class="s">"onChangeDirection"</span><span class="o">)</span>
<span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SnakeController</span> <span class="kd">extends</span> <span class="n">AbstractStateMachine</span><span class="o">&lt;</span><span class="n">SnakeController</span><span class="o">,</span> <span class="n">SnakeState</span><span class="o">,</span> <span class="n">SnakeEvent</span><span class="o">,</span> <span class="n">SnakeContext</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">...</span>
<span class="o">}</span>
</pre></div>

<p>This example can be found in package <em>"org.squirrelframework.foundation.fsm.snake"</em>. </p>
</li>
</ul><h2>
<a name="release-notes" class="anchor" href="#release-notes"><span class="octicon octicon-link"></span></a>Release Notes</h2>

<p><em>Version 0.2.1 - 2013-08-10</em><br>
1. Support test State machine transition result<br>
2. Add <em>StateMachineWithoutContext</em> class to simplify state machine usage without need of context<br>
3. Bug fixed for state machine data dump</p>

<p><em>Version 0.1.10 - 2013-07-13</em><br>
1. Support save/load state machine data</p>

<p><em>Version 0.1.9  - 2013-07-01</em><br>
1. Add to <em>StateMachineBuilderFactory</em> simplify StateMachineBuilder creation<br>
2. Deprecate StateMachineBuilderImpl.newStateMachineBuilder(...) methods</p>

<p><em>Version 0.1.8  - 2013-06-08</em><br>
1. Support <strong>linked state</strong> which also called substatemachine state<br>
2. Rename addListener/removeListener of StateMachine to more specific name add*Listener/remove*Listener<br>
3. Simplify converter registration for String and Enumeration type  </p>

<h2>
<a name="future-plan" class="anchor" href="#future-plan"><span class="octicon octicon-link"></span></a>Future Plan</h2>

<ul>
<li>State machine import and export</li>
<li>Provide thread-safe implementation</li>
<li>Support sendEvent(sync) and postEvent(async)<br>
</li>
<li>Automatic expose as WebService</li>
</ul><h2>
<a name="more-information" class="anchor" href="#more-information"><span class="octicon octicon-link"></span></a>More Information</h2>

<ul>
<li>For the <strong>latest updates</strong> follow <a href="https://twitter.com/hhe11">@hhe11</a>
</li>
<li>For discussions or questions please join the <a href="http://groups.google.com/group/squirrel-state-machine">squirrel state machine group</a>
</li>
<li>For any issue or requirement, please submit an <a href="https://github.com/hekailiang/squirrel/issues?state=open">issue</a>
</li>
</ul>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Squirrel State Machine maintained by <a href="https://github.com/hekailiang">hekailiang</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
